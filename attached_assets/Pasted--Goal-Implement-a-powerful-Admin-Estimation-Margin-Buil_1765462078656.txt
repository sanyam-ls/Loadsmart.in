
Goal: Implement a powerful Admin Estimation & Margin Builder in the Admin Console so operations can create a defensible admin price (from suggested price), apply configurable margins/discounts, preview profit impact, lock the final admin price, and then post/invite/assign the load to carriers at the admin-decided price. All actions must be auditable and sync to carrier boards and shipper notifications.

⸻

1) Feature summary (one-liner)

Add an Admin Estimation & Margin Builder in the Admin Console that:
	•	auto-suggests a baseline price,
	•	lets Admins apply margin rules/adjustments,
	•	previews margin/profit breakout,
	•	locks final admin price, and
	•	posts the load to carriers at that admin price (Open / Invite / Assign).

⸻

2) UX / UI (Admin Console)

Add an Estimation Drawer accessible from Admin Queue and Load Details:

Top bar
	•	Load ID, origin → destination, distance, load type, weight.

Left column — Price Builder
	•	Suggested Price (readonly) — produced by the auto-suggest engine (distance × baseRate × multipliers + fuel surcharge).
	•	Admin Adjustments (editable):
	•	Base markup % (input + slider)
	•	Fixed admin fee (₹)
	•	Fuel surcharge override (₹ or %)
	•	Discount (optional)
	•	Manual final price edit (locks margin calc if edited)
	•	Margin Preview: live display showing:
	•	Suggested price
	•	Admin final price
	•	Platform margin (₹ and %)
	•	Estimated carrier payout (₹)
	•	Estimated profit (₹)
	•	Notes field (admin comment)
	•	Quick Actions
	•	Save as Draft (keeps load in Admin Queue)
	•	Lock Final Price & Post (Open / Invite / Assign)
	•	Send for Approval (if admin override > threshold)
	•	Export price breakdown (CSV/PDF)

Right column — Intelligence & Evidence
	•	Comparable recent loads & prices (last 30/90/365 days)
	•	Top matched carriers & their typical rates
	•	Cost factors used (fuel index, tolls estimate, handling)
	•	Risk flags (low KYC, low carrier availability)
	•	Recommendation confidence score (0–100)

Footer
	•	Audit log preview for this pricing decision (shows who changed what and when).

⸻

3) Data model additions (fields)
	•	AdminPricing table:
	•	id, load_id, admin_id, suggested_price, final_price, markup_percent, fixed_fee, fuel_override, discount_amount, payout_estimate, platform_margin, notes, status {Draft, Locked, AwaitingApproval, Posted, Assigned}, created_at, updated_at.
	•	Add requires_2nd_approval boolean (true when override > threshold).
	•	Add pricing_template_id (allow admins to save common margin templates).

⸻

4) API endpoints (contract)
	•	POST /api/admin/pricing/suggest — return suggested_price + breakdown for a given load (input: load_id).
	•	POST /api/admin/pricing/save — save draft pricing adjustments.
	•	POST /api/admin/pricing/lock — lock final price and (optionally) post to carriers. Payload: { load_id, final_price, post_mode, invite_carrier_ids[] }.
	•	GET /api/admin/pricing/:load_id/history — returns all AdminPricing audit entries.
	•	POST /api/admin/pricing/approve — for second admin to approve overrides.
	•	GET /api/admin/pricing/templates — list saved margin templates.
	•	POST /api/admin/pricing/template — create template.

(Keep auth + role checks.)

⸻

5) Business logic & rules
	•	Suggested Price Algorithm (configurable): distance × baseRate(loadType) + fuelSurcharge(distance, fuelIndex) + handlingFee + seasonalFactor ± regionMultiplier. Provide default coefficients but make them editable in Admin settings.
	•	Margin Rules:
	•	Admin can set markup % or flat fee. System computes final_price = suggested_price × (1 + markup%) + fixed_fee + fuel_override - discount.
	•	If admin manually edits final_price outside ±Y% from suggested_price, flag requires_2nd_approval.
	•	Posting Flow:
	•	If post_mode = Open, create Carrier-accessible load at final_price.
	•	If post_mode = Invite, send invitations to selected carriers with final_price.
	•	If post_mode = Assign, directly create order for selected carrier at final_price.
	•	Accounting:
	•	payout_estimate = final_price - platform_margin (platform_margin = final_price × platform_rate OR explicit fixed fee). Show both projections.
	•	Approval Flow:
	•	If requires_2nd_approval, status = AwaitingApproval and system must block posting until approval endpoint called by another admin.
	•	All approval events are audited.
	•	Templates:
	•	Admins can save margin presets (e.g., Bulk-heavy loads: +8% markup + ₹500 fixed).

⸻

6) Notifications
	•	To Admins: “Pricing locked and posted” / “Pricing requires approval” / “Pricing approved”.
	•	To Carriers: “New load posted by Admin — Price: ₹X” (open/invite/assign).
	•	To Shippers: “Your load has been priced and posted/assigned by Admin at ₹X (status).”

⸻

7) UI acceptance criteria
	•	Admin can open Estimation Drawer for any SubmittedToAdmin load.
	•	The Suggested Price button must compute and show the breakdown instantly.
	•	Admin can change markup/fixed fee/fuel override and see live Margin Preview update.
	•	Admin can lock final price; if override threshold crossed, posting must be blocked until approval.
	•	Locking final price triggers creation of AdminPricing record and audit log.
	•	Posting flow must publish load with admin price to carriers and update load status.
	•	Templates can be saved and reused.
	•	Historical pricing per load is accessible and immutable.

⸻

8) Tests / Mock scenarios (QA checklist)
	1.	Submit raw load from Shipper → appears in Admin Queue with status SubmittedToAdmin.
	2.	Admin opens Estimation Drawer → calls suggest → suggested_price returned + breakdown visible.
	3.	Admin applies +10% markup and ₹500 fixed fee → Margin Preview shows platform margin & payout estimate.
	4.	Admin locks final price within threshold → AdminPricing status Locked and load posted Open → carriers see the load with Posted by Admin and price.
	5.	Admin locks final price outside threshold → AdminPricing status AwaitingApproval → second admin approves → posting occurs.
	6.	Admin uses template → margin values auto-fill → preview correct.
	7.	Audit history shows every step (suggested, edits, lock, approval).
	8.	Posting with Invite sends invites to selected carriers (mock notifications).
	9.	Posting with Assign creates order and moves status to Assigned.
	10.	Dashboard tiles update: Pending Admin Loads decreases; Posted Loads increases; Monthly Revenue preview updates.

⸻

9) Mock data & demo
	•	Seed with 200 SubmittedToAdmin loads, 300 carriers, pre-fill baseRate table for loadTypes, fuelIndex examples for last 12 months.
	•	Provide 3 example pricing templates: Standard (5% markup), Bulk (8% markup + ₹500), Premium (2% markup + ₹1200).

⸻

10) Non-functional & security
	•	All admin pricing actions must be auditable and immutable (store versions).
	•	Sensitive overrides require 2FA (configurable) if > X% deviation.
	•	Role-based checks: only Admin role can call lock and post. Approver role separate for second sign-off.

⸻

11) Deliverables (what Replit should output)
	•	UI mock for Admin Estimation Drawer (screens: Suggest → Edit → Preview → Lock/Approve → Post).
	•	API endpoints implemented as specified with role checks.
	•	Data model with AdminPricing table and audit trails.
	•	Mock dataset and test scripts for QA checklist above.
	•	README: how to edit pricing coefficients, toggle thresholds, and use templates.

⸻

12) Acceptance summary

The system must let Admins reliably generate, edit, preview, approve and lock final admin prices, then post/invite/assign loads to carriers at that price, while keeping full auditability and approval gating for risky overrides.