MASTER EXTENSION: Invoice Builder, Send-Invoice & Edit-Estimation-as-Bid (Admin + Shipper + Carrier)

Objective (one line)

Enable Admin to generate/edit/lock an invoice from the Assign Cost modal, send that invoice to the Shipper portal (invoice is actionable: download, pay, dispute), and optionally send an edited estimation as a carrier bid — all actions are auditable, role-secure, and update dashboards in real time.

⸻

UX Requirements (UI must be wired to APIs)
	1.	Assign Cost Drawer: Add Generate Invoice button and Send Edited Estimation to Carriers button.
	•	Generate Invoice opens Invoice Builder (modal/tab).
	•	Send Edited Estimation to Carriers opens carrier selector + expiry + message.
	2.	Invoice Builder UI (inline editable):
	•	Header: Load ID, Shipper name, Origin → Destination, Admin who created invoice.
	•	Editable line items (rows): code, description, qty, unit price, amount; ability to add/remove lines.
	•	Auto-populated rows from estimation: Base distance cost, Fuel, Handling, Toll, Insurance, Admin fee.
	•	Discount field (abs or %), Tax selector (GST/%), Payment terms (Net0/7/15/30), Currency, Invoice number (auto).
	•	Live totals: Subtotal, Tax, Total, Platform margin, Estimated Carrier Payout.
	•	Buttons: Save Draft, Download PDF, Send to Shipper, Send Edited Estimation to Carriers, Record Payment, Cancel.
	•	Validation: required fields, numeric formats, tax calculations.
	3.	Shipper Portal — Invoices area:
	•	Shows new invoice under load detail and Invoices tab.
	•	Actions: Download PDF, Acknowledge, Raise Query, Pay Now (mock), View History.
	•	Invoice status states: Draft, SentToShipper, Acknowledged, Paid, Disputed, Cancelled, Revised.
	4.	Carrier Flow:
	•	If Admin chooses Send Edited Estimation to Carriers the selected carriers get a Proposed Payout invite with the edited payout and can Accept or Counter (counter goes to Admin queue).
	•	If carrier accepts, Admin can Assign and invoice/payment flows proceed.
	5.	Error Handling:
	•	If Send fails, show descriptive toast with retry and log error: Failed to send invoice: <reason>.
	•	Ensure idempotency: repeated clicks do not create duplicate invoices (use server-side idempotency_key).

⸻

Data Model Additions
	•	Invoice:
	•	id, invoice_number, load_id, admin_id, shipper_id, line_items(JSON), subtotal, tax_amount, total, currency, payment_terms, status, created_at, updated_at, invoice_pdf_url.
	•	InvoiceHistory:
	•	invoice_id, admin_id, action (create/edit/send/pay/dispute), payload, timestamp.
	•	Link: Invoice.admin_pricing_id → AdminPricing record.
	•	CarrierProposal (for edited estimations):
	•	id, invoice_id (optional), load_id, proposed_payout, carrier_id, expiry, status.

⸻

API Endpoints (required)
	•	POST /api/admin/invoice/generate — body {load_id, admin_id, line_items, tax, payment_terms} → returns invoice draft.
	•	GET /api/admin/invoice/:id — get invoice detail.
	•	POST /api/admin/invoice/:id/send — {notifyShipper:true} → atomically mark status=SentToShipper, create InvoiceHistory, generate PDF (sync/async).
	•	POST /api/admin/invoice/:id/download — returns PDF URL/stream.
	•	POST /api/admin/invoice/:id/send-to-carriers — {carrier_ids[], expiry_hours, message} → create CarrierProposal records + notifications.
	•	POST /api/shipper/invoice/:id/acknowledge — mark acknowledged + create history.
	•	POST /api/shipper/invoice/:id/pay — mock payment flow; mark paid + create Payment record.
	•	POST /api/shipper/invoice/:id/query — create dispute ticket.
	•	POST /api/admin/invoice/:id/record-payment — admin reconciliation.
	•	GET /api/invoices?filters= — for dashboards.

All endpoints require role-based token; write integration tests to ensure RBAC.

⸻

Business Rules (explicit)
	1.	Immutability & Revisions: Once SentToShipper, invoice can’t be edited — any change creates a new invoice revision number; the previous invoice is marked Revised.
	2.	Approval Threshold: If Admin final_total deviates > X% from suggested_price, requires_second_approval=true and send is blocked until approved.
	3.	Carrier Proposal Rules: Carrier acceptance locks the load for assignment for 10 minutes unless Admin de-duplicates; counters go back to Admin queue.
	4.	Payment Settlement: Payment updates dashboards when Paid and triggers settlement pipeline (mock or real).
	5.	Audit: Every action writes InvoiceHistory with user_id, timestamp, and payload.

⸻

PDF Invoice Requirements
	•	Standard format: header with company info, invoice number, date, shipper details, load summary, itemized table, tax, total, payment terms, bank/UPI details, notes, admin signature.
	•	Generated server-side (or via reliable client-side render) and stored with secure access.

⸻

Notifications (templates)
	•	Admin → Shipper: Invoice Sent (link + amount + due date)
	•	Shipper → Admin: Invoice Acknowledged / Invoice Query Created / Payment Completed
	•	Carrier → Admin: Proposal Accepted / Counter Offer
	•	All channels: in-app + email; mock SMS/WhatsApp acceptable during MVP.

⸻

Acceptance Tests (must pass)
	1.	Generate & Save Draft: Admin opens Assign Cost → Generate Invoice → edits line items → Save Draft → GET /api/admin/invoice/:id returns saved draft.
	2.	Send to Shipper: Admin clicks Send to Shipper → API returns 200 and invoice.status=SentToShipper → Shipper UI shows invoice in Invoices tab with Download and Acknowledge.
	3.	Download PDF: Shipper downloads PDF → content matches invoice lines, totals, invoice number.
	4.	Pay Now (mock): Shipper clicks Pay → Payment record created, invoice.status=Paid, notifications fired to admin.
	5.	Send Edited Estimation to Carriers: Admin sends to 3 carriers → each receives proposal; carrier A accepts → CarrierProposal status updates → Admin receives acceptance and can Assign.
	6.	Idempotency: Repeated clicks on Send do not create duplicate invoices (server returns same invoice id and 200).
	7.	Audit Trail: InvoiceHistory contains create, edit, send, shipper_ack, payment events with correct payload and timestamps.
	8.	RBAC: Only Admin can create/send; only Shipper for that load can acknowledge/pay; only chosen carriers can accept proposals.
	9.	Failure & Retry: If POST /api/admin/invoice/:id/send fails with network error, UI shows descriptive error and allows retry with same idempotency key.

⸻

Mock Data & Simulation
	•	Seed 50 invoices: 20 drafts, 20 sent, 5 paid, 5 disputed.
	•	Seed carriers and trucks so send-to-carriers demo works.
	•	If real payment gateway unavailable, provide a mocked Pay flow that sets invoice to Paid and creates settlement record.

⸻

Security & Compliance
	•	Validate all currency and numeric fields server-side.
	•	Invoices and attachments stored behind auth.
	•	Maintain immutable audit logs for reconciliation and dispute resolution.

⸻

Deliverable Checklist (hand to QA)
	•	Invoice Builder UI wired to API and fully functional.
	•	PDF generation and download verified.
	•	Shipper portal invoice acceptance and mock payment flow validated.
	•	Carrier proposal flow (send/accept/counter) validated.
	•	Audit logs and dashboards reflect invoice states.
	•	Error handling and idempotency implemented and tested.